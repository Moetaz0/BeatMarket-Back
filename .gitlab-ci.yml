stages:
    - lint
    - test
    - docker

workflow:
    rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_BRANCH

variables:
    COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"
    APP_ENV: test
    SYMFONY_PHPUNIT_VERSION: "11.4"

.php_template:
    image: php:8.2-cli
    before_script:
        - apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends git unzip libicu-dev libpq-dev libzip-dev
        - docker-php-ext-install intl pdo_pgsql zip
        - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    cache:
        key: composer
        policy: pull-push
        paths:
            - vendor/
            - .composer-cache/

composer-validate:
    stage: lint
    extends: .php_template
    script:
        - composer validate --no-check-lock

php-tests:
    stage: test
    extends: .php_template
    services:
        - name: postgres:16-alpine
          alias: db
    variables:
        POSTGRES_DB: app
        POSTGRES_USER: app
        POSTGRES_PASSWORD: secret
        DATABASE_URL: "postgresql://app:secret@db:5432/app?serverVersion=16&charset=utf8"
    script:
        - composer install --no-interaction --prefer-dist
        - |
            if [ -x vendor/bin/phpunit ]; then
              vendor/bin/phpunit --testdox;
            else
              echo "PHPUnit not configured; skipping tests.";
            fi
    artifacts:
        when: always
        expire_in: 1 day
        paths:
            - var/log/

docker-build-push:
    stage: docker
    image: docker:27.1.1
    services:
        - name: docker:27.1.1-dind
          alias: docker
    variables:
        DOCKER_DRIVER: overlay2
        DOCKER_TLS_CERTDIR: "/certs"
    before_script:
        - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    script:
        - IMAGE_NAME="$DOCKERHUB_USERNAME/beatmarket-api"
        - docker build -t "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" .
        - docker push "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
        - |
            if [ "$CI_COMMIT_BRANCH" = "main" ]; then
              docker tag "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" "$IMAGE_NAME:latest"
              docker push "$IMAGE_NAME:latest"
            fi
    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'
          when: on_success
